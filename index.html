<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ è”ä¿¡èµ„ ğŸ ğŸ ç¥æ‚¨å¥½è¿ ğŸ</title>

<script src="https://cdn.jsdelivr.net/npm/firebase@10.13.0/firebase-app-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.13.0/firebase-firestore-compat.js"></script>

<style>
:root{--bg:#0b1222;--card:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--primary:#22d3ee;--ok:#34d399;--warn:#fbbf24}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:linear-gradient(180deg,#0b1222,#0f172a);
  color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;overflow-x:hidden;}
.wrap{max-width:1000px;margin:36px auto;padding:0 16px;text-align:center;}
.title{font-weight:800;font-size:30px;line-height:1.5;color:#f1f5f9;
  text-shadow:0 0 15px rgba(34,211,238,.7),0 0 30px rgba(34,211,238,.3);letter-spacing:1px;margin-bottom:10px;}
.card{background:rgba(17,24,39,.88);border:1px solid #1f2937;border-radius:20px;
  padding:18px;box-shadow:0 10px 30px #0006;text-align:center;margin-top:20px;}
.btn{cursor:pointer;border:1px solid #1f2937;color:#0b1222;background:var(--primary);
  border-radius:14px;padding:10px 14px;font-weight:800;margin:6px}
.btn.ok{background:var(--ok);color:#062b1e}
.btn.secondary{background:#1f2937;color:var(--text)}
.btn.warn{background:var(--warn);color:#3b2900}
.amount{font-size:56px;font-weight:900;letter-spacing:1px}
.hint{font-size:12px;color:#94a3b8}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">ğŸ è”ä¿¡èµ„ ğŸ<br>ğŸ ç¥æ‚¨å¥½è¿ ğŸ</div>
  <div class="hint">æ— éœ€è¾“å…¥IDï¼Œæ¯äººé™æŠ½ä¸€æ¬¡</div>

  <div class="card">
    <div id="roundInfo">å¥–æ± ï¼šç‰¹ç­‰å¥– + ç°é‡‘çº¢åŒ…ï¼ˆå…±21ä»½ï¼‰</div>
    <div id="statusInfo" class="hint">çŠ¶æ€ï¼šè¿›è¡Œä¸­</div>
    <button class="btn ok" id="draw">æŠ½çº¢åŒ…</button>
    <button class="btn secondary" id="export">å¯¼å‡ºè®°å½•</button>
    <button class="btn warn" id="reset">é‡ç½®å¥–æ± ï¼ˆéœ€å¯†ç ï¼‰</button>

    <div style="margin-top:18px">
      <div class="hint">æœ¬æ¬¡æŠ½ä¸­ç»“æœ</div>
      <div id="amountView" class="amount">â€”</div>
    </div>
    <div class="hint" id="leftInfo" style="margin-top:8px"></div>
  </div>

  <div class="card" style="text-align:left">
    <div class="hint">æŠ½å¥–è®°å½•ï¼š</div>
    <table style="width:100%;border-collapse:collapse;font-size:14px">
      <thead><tr><th>ç¼–å·</th><th>æ—¶é—´</th><th style="text-align:right">ç»“æœ</th></tr></thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>
</div>

<script>
/* ---------- Firebase ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBqiysQdJzUMfn-zwzeEu8hhU0T51OKGGA",
  authDomain: "redpacket-lottery.firebaseapp.com",
  projectId: "redpacket-lottery",
  storageBucket: "redpacket-lottery.appspot.com",
  messagingSenderId: "252110350053",
  appId: "1:252110350053:web:60b394678bb8910ae6560c",
  measurementId: "G-5MXFC392RP"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------- é…ç½® ---------- */
const ADMIN_PASSWORD = "happy888"; // âœ… æ­£ç¡®å¯†ç 
const CURRENCY = "å…ƒ";

let pool = [];
let history = [];
let userDraws = {};
let locked = false;
let unsubscribe = null;

/* ---------- å¥–æ± å›ºå®šé‡‘é¢ ---------- */
function createFixedPool(){
  const list = [];
  for(let i=0;i<5;i++) list.push("38" + CURRENCY);
  for(let i=0;i<5;i++) list.push("88" + CURRENCY);
  for(let i=0;i<5;i++) list.push("188" + CURRENCY);
  for(let i=0;i<5;i++) list.push("288" + CURRENCY);
  list.push("ğŸ‰ ç‰¹ç­‰å¥–ï¼šOPPO K13 Turbo 5G æ‰‹æœº ğŸ");
  return shuffle(list);
}

/* ---------- å·¥å…· ---------- */
function shuffle(a){const arr=[...a];for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

/* ---------- åˆå§‹åŒ– ---------- */
async function init(){
  const ref = db.collection("lottery").doc("roundOne");
  const snap = await ref.get();
  if(!snap.exists){
    pool = createFixedPool();
    await ref.set({pool, history:[], userDraws:{}, locked:false});
  }
  if (unsubscribe) unsubscribe(); // ç§»é™¤æ—§ç›‘å¬
  unsubscribe = ref.onSnapshot(doc=>{
    const d = doc.data();
    pool = d.pool || [];
    history = d.history || [];
    userDraws = d.userDraws || {};
    locked = !!d.locked;
    render();
  });
}

async function syncSave(){
  await db.collection("lottery").doc("roundOne").set({pool, history, userDraws, locked},{merge:true});
}

/* ---------- æŠ½å¥– ---------- */
async function drawOne(){
  if(locked){alert("æŠ½å¥–å·²ç»“æŸï¼");return;}
  const uid = "user_" + Math.random().toString(36).slice(2,8);
  if(userDraws[uid]){alert("æ‚¨å·²æŠ½è¿‡ä¸€æ¬¡å•¦ï¼");return;}
  if(pool.length===0){alert("æ‰€æœ‰å¥–é¡¹å·²æŠ½å®Œï¼");locked=true;await syncSave();return;}

  const prize = pool.shift();
  userDraws[uid] = true;
  const record = {id:uid, t:new Date().toLocaleString(), v:prize};
  history.unshift(record);

  alert(`ğŸ‰ æ­å–œï¼æ‚¨è·å¾—ï¼š${prize}`);
  document.querySelector("#amountView").textContent = prize;

  if(pool.length===0){locked=true;}
  await syncSave();
  render();
}

/* ---------- é‡ç½®åŠŸèƒ½ ---------- */
async function resetLottery(){
  const pwd = prompt("è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç è¿›è¡Œé‡ç½®ï¼š");
  if(!pwd){return;}
  if(pwd.trim() !== ADMIN_PASSWORD){
    alert("âŒ å¯†ç é”™è¯¯ï¼");
    return;
  }

  if(!confirm("ç¡®å®šè¦é‡ç½®å¥–æ± å¹¶æ¸…ç©ºè®°å½•å—ï¼Ÿ")) return;

  // åœæ­¢ç›‘å¬é˜²æ­¢å¼‚æ­¥å†²çª
  if (unsubscribe) unsubscribe();

  pool = createFixedPool();
  history = [];
  userDraws = {};
  locked = false;

  await db.collection("lottery").doc("roundOne").set({
    pool, history, userDraws, locked
  });

  alert("âœ… å¥–æ± å·²é‡ç½®æˆåŠŸï¼");
  init(); // é‡æ–°ç›‘å¬
  render();
}

/* ---------- å¯¼å‡º ---------- */
function exportCSV(){
  if(history.length===0){alert("æš‚æ— è®°å½•");return;}
  const rows=[["ç¼–å·","æ—¶é—´","ç»“æœ"],...history.map(h=>[h.id,h.t,h.v])];
  const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=`records_${Date.now()}.csv`;a.click();
}

/* ---------- æ¸²æŸ“ ---------- */
function render(){
  document.querySelector("#leftInfo").textContent=`å‰©ä½™å¥–é¡¹ï¼š${pool.length}`;
  document.querySelector("#statusInfo").textContent=`çŠ¶æ€ï¼š${locked?"å·²ç»“æŸ":"è¿›è¡Œä¸­"}`;
  document.querySelector("#logBody").innerHTML=history
    .map(h=>`<tr><td>${h.id}</td><td>${h.t}</td><td style='text-align:right'>${h.v}</td></tr>`)
    .join("");
}

/* ---------- å¯åŠ¨ ---------- */
document.querySelector("#draw").addEventListener("click",drawOne);
document.querySelector("#export").addEventListener("click",exportCSV);
document.querySelector("#reset").addEventListener("click",resetLottery);
init();
</script>
</body>
</html>
