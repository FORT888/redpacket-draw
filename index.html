<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>éšæœºçº¢åŒ…æŠ½å¥–ï¼ˆä¸‰è½®é¡ºåºè§£é” + çƒŸèŠ±ç‰¹æ•ˆï¼‰</title>
<style>
:root{--bg:#0b1222;--card:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--primary:#22d3ee;--ok:#34d399;--warn:#fbbf24}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:linear-gradient(180deg,#0b1222,#0f172a);
  color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;overflow-x:hidden;}
.wrap{max-width:1000px;margin:36px auto;padding:0 16px}
.title{text-align:center;font-weight:800;font-size:24px}
.card{background:rgba(17,24,39,.88);border:1px solid #1f2937;border-radius:20px;
  padding:18px;box-shadow:0 10px 30px #0006;text-align:center}
.btn{cursor:pointer;border:1px solid #1f2937;color:#0b1222;background:var(--primary);
  border-radius:14px;padding:10px 14px;font-weight:800;margin:6px}
.btn.ok{background:var(--ok);color:#062b1e}
.btn.warn{background:var(--warn);color:#3b2900}
.btn.secondary{background:#1f2937;color:var(--text)}
.btn.ghost{background:transparent;color:var(--muted);border-color:#243041}
.disabled{opacity:.55;pointer-events:none}
.amount{font-size:56px;font-weight:900;letter-spacing:1px}
.hint{font-size:12px;color:var(--muted)}
.firework{
  position:fixed;left:50%;top:50%;width:6px;height:6px;border-radius:50%;
  background:#fff;pointer-events:none;animation:boom 1s ease-out forwards;
}
@keyframes boom{
  from{opacity:1;transform:scale(1) translate(0,0);}
  to{opacity:0;transform:scale(2) translate(var(--x),var(--y));}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">ğŸ éšæœºçº¢åŒ…æŠ½å¥–</div>
  <div class="card" style="margin-top:20px">
    <div id="roundInfo">å½“å‰ï¼šâ€”</div>
    <div id="statusInfo" class="hint">çŠ¶æ€ï¼šæœªå¼€å§‹</div>
    <button class="btn ok" id="draw">æŠ½çº¢åŒ…</button>
    <button class="btn ghost" id="export">å¯¼å‡ºè®°å½•</button>
    <button class="btn secondary" id="reset">é‡ç½®ï¼ˆç®¡ç†å‘˜ï¼‰</button>
    <button class="btn warn disabled" id="next">å¼€å§‹ä¸‹ä¸€è½®ï¼ˆç®¡ç†å‘˜ç¡®è®¤ï¼‰</button>
    <div style="margin-top:18px">
      <div class="hint">æœ¬æ¬¡æŠ½ä¸­é‡‘é¢</div>
      <div id="amountView" class="amount">â€”</div>
    </div>
    <div class="hint" id="leftInfo" style="margin-top:8px">å‰©ä½™ï¼šâ€”</div>
    <div class="hint" id="quotaInfo" style="margin-top:4px"></div>
  </div>

  <div class="card" style="margin-top:20px;text-align:left">
    <div class="hint">æŠ½å¥–è®°å½•ï¼š</div>
    <table style="width:100%;border-collapse:collapse;font-size:14px">
      <thead>
        <tr><th>#</th><th>æ—¶é—´</th><th>è½®æ¬¡</th><th style="text-align:right">é‡‘é¢</th></tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>
</div>

<script>
const PRESETS=[
  {name:"ç¬¬ 1 è½®",total:500,count:3,min:8.8},  // âœ… æ”¹ä¸º3ä¸ªåé¢
  {name:"ç¬¬ 2 è½®",total:1000,count:70,min:8.8},
  {name:"ç¬¬ 3 è½®",total:1000,count:100,min:8.8}
];
const CURRENCY="Â¥";
let roundIndex=0,pool=[],history=[],roundLocked=true,userDrawMap={0:false,1:false,2:false};
const els={
  draw:document.querySelector("#draw"),
  export:document.querySelector("#export"),
  reset:document.querySelector("#reset"),
  next:document.querySelector("#next"),
  amountView:document.querySelector("#amountView"),
  logBody:document.querySelector("#logBody"),
  roundInfo:document.querySelector("#roundInfo"),
  statusInfo:document.querySelector("#statusInfo"),
  leftInfo:document.querySelector("#leftInfo"),
  quotaInfo:document.querySelector("#quotaInfo")
};

function randomRedPackets(total,count,min){
  const result=[];let remain=total;
  for(let i=0;i<count-1;i++){
    const max=(remain-min*(count-i-1))*2/(count-i);
    const money=Math.random()*(Math.max(min,max)-min)+min;
    const v=Math.floor(money*100)/100;result.push(v);remain-=v;
  }
  result.push(Number(remain.toFixed(2)));return result;
}
function shuffle(a){const arr=[...a];
  for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}
  return arr;
}

function save(){
  localStorage.setItem("three-round-packets",JSON.stringify({roundIndex,pool,history,roundLocked,userDrawMap}));
}
function restore(){
  const raw=localStorage.getItem("three-round-packets");
  if(!raw){roundIndex=0;roundLocked=false;userDrawMap={0:false,1:false,2:false};generateRound(0);return;}
  const d=JSON.parse(raw);
  roundIndex=d.roundIndex||0;pool=d.pool||[];history=d.history||[];
  roundLocked=!!d.roundLocked;userDrawMap=d.userDrawMap||{0:false,1:false,2:false};
  render();
}

function generateRound(i){
  const p=PRESETS[i];
  pool=shuffle(randomRedPackets(p.total,p.count,p.min));
  roundLocked=false;
  if(typeof userDrawMap[i]==="undefined") userDrawMap[i]=false;
  save();render();
}

function drawOne(){
  if(roundLocked){alert("å½“å‰è½®æœªå¼€æ”¾ï¼Œç­‰å¾…ç®¡ç†å‘˜å¼€å§‹ä¸‹ä¸€è½®");return;}
  if(pool.length===0){alert("æœ¬è½®å·²æŠ½å®Œï¼Œç­‰å¾…ç®¡ç†å‘˜å¼€å§‹ä¸‹ä¸€è½®");return;}
  if(userDrawMap[roundIndex]){alert("æ‚¨æœ¬è½®å·²ç»æŠ½è¿‡ä¸€æ¬¡å•¦ï¼Œä¸‹è½®å¼€æ”¾åå†æ¥ï½");return;}
  const idx=Math.floor(Math.random()*pool.length);
  const v=pool.splice(idx,1)[0];
  history.unshift({t:new Date().toISOString(),v,roundName:PRESETS[roundIndex].name});
  userDrawMap[roundIndex]=true;
  showFireworks();
  alert(`ğŸ‰ æ­å–œè·å¾— ${CURRENCY}${v.toFixed(2)}ï¼`);
  animateAmount(v);
  save();render();
  if(pool.length===0){roundLocked=true;save();render();alert(`${PRESETS[roundIndex].name} å·²æŠ½å®Œï¼Œè¯·ç®¡ç†å‘˜ç‚¹å‡»â€œå¼€å§‹ä¸‹ä¸€è½®â€ã€‚`);els.next.classList.remove("disabled");}
}

function startNext(){
  if(pool.length>0){alert("å½“å‰è½®å°šæœªæŠ½å®Œ");return;}
  if(roundIndex>=PRESETS.length-1){alert("å·²æ˜¯æœ€åä¸€è½®");return;}
  roundIndex+=1;generateRound(roundIndex);
  alert(`${PRESETS[roundIndex].name} å·²å¼€å§‹ï¼`);els.next.classList.add("disabled");
}

function resetAll(){
  if(!confirm("ç¡®å®šè¦é‡ç½®å—ï¼Ÿè¿™ä¼šæ¸…ç©ºæ‰€æœ‰è®°å½•å¹¶é‡æ–°å¼€å§‹ã€‚"))return;
  roundIndex=0;history=[];roundLocked=false;userDrawMap={0:false,1:false,2:false};
  generateRound(0);save();render();els.next.classList.add("disabled");
}

function exportCSV(){
  if(history.length===0){alert("æš‚æ— è®°å½•");return;}
  const rows=[["Index","Time","Round","Amount"],
    ...history.map((h,i)=>[i+1,new Date(h.t).toLocaleString(),h.roundName,`${CURRENCY}${h.v.toFixed(2)}`])];
  const csv=rows.map(r=>r.map(c=>`\"${String(c).replace(/\"/g,'\"\"')}\"`).join(",")).join("\\n");
  const blob=new Blob(['\\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);
  a.download=`records_${Date.now()}.csv`;a.click();
}

function animateAmount(target){els.amountView.textContent=`${CURRENCY}${target.toFixed(2)}`;}

function render(){
  const p=PRESETS[roundIndex];
  els.roundInfo.textContent=`å½“å‰ï¼š${p.name}ï¼ˆæ€»é¢ ${CURRENCY}${p.total} / ${p.count} åŒ…ï¼‰`;
  els.leftInfo.textContent=`å‰©ä½™ï¼š${pool.length} åŒ…`;
  els.quotaInfo.textContent=userDrawMap[roundIndex]?"æ‚¨æœ¬è½®å·²æŠ½è¿‡":"æ‚¨æœ¬è½®å°šæœªæŠ½";
  els.statusInfo.textContent=`çŠ¶æ€ï¼š${roundLocked?"æœªå¼€æ”¾":"è¿›è¡Œä¸­"}`;
  els.logBody.innerHTML=history.map((h,i)=>`<tr><td>${i+1}</td><td>${new Date(h.t).toLocaleString()}</td><td>${h.roundName}</td><td style='text-align:right'>${CURRENCY}${h.v.toFixed(2)}</td></tr>`).join("");
}

function showFireworks(){
  for(let i=0;i<25;i++){
    const f=document.createElement('div');
    f.className='firework';
    f.style.setProperty('--x',`${(Math.random()-0.5)*400}px`);
    f.style.setProperty('--y',`${(Math.random()-0.5)*400}px`);
    f.style.background=`hsl(${Math.random()*360},100%,70%)`;
    document.body.appendChild(f);
    setTimeout(()=>f.remove(),1000);
  }
}

els.draw.addEventListener("click",drawOne);
els.next.addEventListener("click",startNext);
els.reset.addEventListener("click",resetAll);
els.export.addEventListener("click",exportCSV);
restore();
</script>
</body>
</html>

